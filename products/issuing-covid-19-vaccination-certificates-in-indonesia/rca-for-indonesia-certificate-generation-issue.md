# RCA for Indonesia: Certificate Generation Issue

## **Incident Overview**&#x20;

The Indonesia team reported that they were unable to download certificates on December 15, 2022. They made an API request to download the certificate, but the certificate API service was not reachable and received a 502 gateway timeout.

<figure><img src="../../.gitbook/assets/Screenshot 2022-12-28 at 5.10.06 PM.png" alt=""><figcaption></figcaption></figure>

## **RCA**

* Master and slave nodes of the cluster are reachable.
* On running the “**kubectl get pods -n divoc**” command on the master node, an error appeared: “Client certificates generated by kubeadm are expired. Can’t reach the cluster.”
* The “**kubeadm certs check-expiration**” command was executed on the master node to check the expiration of certificates.
* It was identified that the certificate has expired. Hence kube-apiserver, kube-scheduler, kube-controller-manager services were not able to manage DIVOC services deployed on worker nodes.

## **Steps taken to resolve the incident**

The following commands were run on the master node to resolve the issue:

* Took backup of the older config

```
cp ~/.kube/config ~/.kube/dec-11-2022-expired-config
```

* Renewed the certificates

```
kubeadm certs renew all
```

* Copied newly generated certificates to kubeadm conf

```
cp /etc/kubernetes/admin.conf ~/.kube/config
```

* Restarted Kubelet

```
systemctl restart kubelet
```

* Restarted kube-apiserver, kube-controller-manager, kube-scheduler, and etcd, so that they can use newly generated certificates.

&#x20;      \- Listed the running services in the default namespace on the master node: ****&#x20;

```
docker ps
```

&#x20;       ****        - Stopped and removed kube-apiserver, kube-controller-manager, kube-scheduler, and etcd services so that the services restart.

```
docker stop <containerId>
docker rm <containerId>
```

* As soon as these services were restarted, they were able to restart the services (certificate-API) which had gone down on the slave node.

### How to prevent a similar issue in the future?

In a managed Kubernetes service, the certificates are auto-renewed upon expiry, Since Indonesia is set up as a non-managed k8s cluster, the kube certificates have to be renewed manually.\


References used:&#x20;

* [https://stackoverflow.com/a/72111095/12839195](https://stackoverflow.com/a/72111095/12839195)
* [https://www.youtube.com/watch?v=h6YtDQ-Qtsk\&ab\_channel=JustmeandOpensource](https://www.youtube.com/watch?v=h6YtDQ-Qtsk\&ab\_channel=JustmeandOpensource)

\
[![Creative Commons License](https://i.creativecommons.org/l/by/4.0/80x15.png)](http://creativecommons.org/licenses/by/4.0/)_All content on this page by_ [_eGov Foundation_](https://egov.org.in/) _is licensed under a_ [_Creative Commons Attribution 4.0 International License_](http://creativecommons.org/licenses/by/4.0/)_._
